{% extends "admin/base.html" %}

{% block title %}Users{% endblock %}
{% block header %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
     <h2>Users</h2>
</div>
<div class="table-responsive">
    <table class="table table-striped table-sm">
    <thead>
        <tr>
        <th>#</th>
        <th>User</th>
        <th>Email</th>
        <th>Access</th>
        <th>LDAP</th>
        <th>Last available in</th>
        <th>Created in</th>
        <th style="text-align: center;">Actions</th>
        </tr>
    </thead>
    <tbody>

        {% for user in users %}
          <tr>
          <td id="user_id" data-content="{{user.id}}">{{user.id}}</td>
          <td><span data-feather="user"></span> {{user.login}}</td>
          <td><span data-feather="mail"></span> {{user.email}}</td>
          <td id="user_access_level" data-content="{{user.access_level}}"><span data-feather="award"></span> {{user.access_level}}</td>
          <td>{{user.is_ldap}}</td>
          <td>{{user.last_logged_in}}</td>
          <td>{{user.created}}</td>
          <td style="text-align: center;">
            {% if user.access_level < 2 %}
                <button type="button" class="btn btn-secondary access-btn"
                data-toggle="tooltip" data-placement="top" title="Grant access"
                style="padding-top: 0px;padding-bottom: 2px;padding-right: 5px;padding-left: 5px"
                data-toggle="modal" data-target="#exampleModal" data-whatever="@mdo">
                <span data-feather="arrow-up-circle"></span>
            {% else %}
                <button type="button" class="btn btn-secondary access-btn"
                data-toggle="tooltip" data-placement="top" title="Revoke access"
                style="padding-top: 0px;padding-bottom: 2px;padding-right: 5px;padding-left: 5px"
                data-toggle="modal" data-target="#exampleModal" data-whatever="@mdo">
                <span data-feather="arrow-down-circle"></span>
            {% endif %}
        </button>
          </td>
          </tr>
        {% endfor %}
    </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        $(".access-btn").click(function() {
            var id = $( "#user_id", $(this).parent().parent() ).data("content");
            var access_level = $( "#user_access_level", $(this).parent().parent() ).data("content");

            if (id == null || id == "") {
                id = 0;
            }

            if (access_level == 1) {
                access_level = 2;
            } else {
                access_level = 1;
            }

            console.log("id: " + id);
            console.log("access_level: " + access_level);

            $.ajax({
                type: "PATCH",
                url: 'users',
                data: {"id": id, "access_level": access_level},
                success: function(data)
                {
                    location.reload();
                },
                error: function(jqXHR, textStatus, errorThrown)
                {
                    alert(jqXHR.responseText);
                }

            });
        });
    });
</script>
{% endblock %}